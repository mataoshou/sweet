package business.program;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.log4j.Logger;

import tool.common.Convert;
import business.db.SweetProgram;

//机构数据，获取、更新
public class ProgramTask extends Thread
{
	Logger logger = Logger.getLogger(ProgramTask.class);
	static ProgramTask one;

	public static ProgramTask i()
	{
		if (one == null)
		{
			one = new ProgramTask();
		}
		return one;
	}

	// 栏目数据
	Map<Integer, SweetProgram> m_map = new HashMap();

	Object m_lock = new Object();

	public void startService()
	{
		logger.debug(".......栏目任务启动.......");
		start();
	}

	@Override
	public void run()
	{
		while (true)
		{
			initData();//初始化数据

			try
			{
				Thread.sleep(1000 * 60 * 60);
			} catch (InterruptedException e)
			{
				e.printStackTrace();
			}
		}
	}

	// 更新数据
	void initData()
	{
		try
		{
			List list = ProgramUtil.list();
			synchronized (m_lock)
			{
				m_map.clear();
				for (int i = 0; i < list.size(); i++)
				{
					SweetProgram p = (SweetProgram) list.get(i);
					m_map.put(p.getId(), p);
				}
			}
		} catch (Exception e)
		{
			e.printStackTrace();
		}
	}

	// 获取栏目数据
	public SweetProgram get(int programId)
	{
		if (m_map.containsKey(programId))
		{
			return m_map.get(programId);
		}
		return null;
	}

	// 获取栏目列表
	public List list()
	{
		List l = Convert.valuetoList(m_map);
		return l;
	}

	// 获取子栏目
	public List list(int parent)
	{
		List l = Convert.valuetoList(m_map);
		List result = new ArrayList();
		for (int i = 0; i < l.size(); i++)
		{
			SweetProgram p = (SweetProgram) l.get(i);
			if (p.getParent() == parent)
			{
				result.add(p);
			}
		}
		return result;
	}
}
